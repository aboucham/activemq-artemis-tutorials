#---
#kind: Secret
#apiVersion: v1
#metadata:
#  name: keycloak-jaas-config
#  namespace: amq
#data:
#  _keycloak-bearer-token.json: ewogICAgInJlYWxtIjogImFtcS1icm9rZXItcmVhbG0iLAogICAgInJlc291cmNlIjogImFtcS1jb25zb2xlIiwKICAgICJhdXRoLXNlcnZlci11cmwiOiAiaHR0cHM6Ly9rZXljbG9hay1ob3N0LmFwcHMuYWJvdWNoYW1hLWFpLmVtZWEuYXdzLmNlZS5zdXBwb3J0IiwKICAgICJwcmluY2lwYWwtYXR0cmlidXRlIjogInByZWZlcnJlZF91c2VybmFtZSIsCiAgICAidXNlLXJlc291cmNlLXJvbGUtbWFwcGluZ3MiOiBmYWxzZSwKICAgICJzc2wtcmVxdWlyZWQiOiAiZXh0ZXJuYWwiLAogICAgImNvbmZpZGVudGlhbC1wb3J0IjogMAp9Cg==
#  _keycloak-direct-access.json: ewogICAgInJlYWxtIjogImFtcS1icm9rZXItcmVhbG0iLAogICAgInJlc291cmNlIjogImFtcS1icm9rZXIiLAogICAgImF1dGgtc2VydmVyLXVybCI6ICJodHRwczovL2tleWNsb2FrLWhvc3QuYXBwcy5hYm91Y2hhbWEtYWkuZW1lYS5hd3MuY2VlLnN1cHBvcnQiLAogICAgInByaW5jaXBhbC1hdHRyaWJ1dGUiOiAicHJlZmVycmVkX3VzZXJuYW1lIiwKICAgICJ1c2UtcmVzb3VyY2Utcm9sZS1tYXBwaW5ncyI6IGZhbHNlLAogICAgInNzbC1yZXF1aXJlZCI6ICJleHRlcm5hbCIsCiAgICAiY3JlZGVudGlhbHMiOiB7CiAgICAgICAgInNlY3JldCI6ICJDbWNCNXNrWURtOGZET0laa3NtY3p2NlU2ejU3bDJ3NSIKICAgIH0KfQo=
#  _keycloak-js-client.json: ewogICJyZWFsbSI6ICJhbXEtYnJva2VyLXJlYWxtIiwKICAiY2xpZW50SWQiOiAiYW1xLWNvbnNvbGUiLAogICJ1cmwiOiAiaHR0cHM6Ly9rZXljbG9hay1ob3N0LmFwcHMuYWJvdWNoYW1hLWFpLmVtZWEuYXdzLmNlZS5zdXBwb3J0Igp9Cg==
#  login.config: Y29uc29sZSB7CiAgICAvLyBlbnN1cmUgdGhlIG9wZXJhdG9yIGNhbiBjb25uZWN0IHRvIHRoZSBicm9rZXIgYnkgcmVmZXJlbmNpbmcgdGhlIGV4aXN0aW5nIHByb3BlcnRpZXMgY29uZmlnCiAgICBvcmcuYXBhY2hlLmFjdGl2ZW1xLmFydGVtaXMuc3BpLmNvcmUuc2VjdXJpdHkuamFhcy5Qcm9wZXJ0aWVzTG9naW5Nb2R1bGUgc3VmZmljaWVudAogICAgICAgIG9yZy5hcGFjaGUuYWN0aXZlbXEuamFhcy5wcm9wZXJ0aWVzLnVzZXI9ImFydGVtaXMtdXNlcnMucHJvcGVydGllcyIKICAgICAgICBvcmcuYXBhY2hlLmFjdGl2ZW1xLmphYXMucHJvcGVydGllcy5yb2xlPSJhcnRlbWlzLXJvbGVzLnByb3BlcnRpZXMiCiAgICAgICAgYmFzZURpcj0iL2hvbWUvamJvc3MvYW1xLWJyb2tlci9ldGMiOwoKICAgb3JnLmtleWNsb2FrLmFkYXB0ZXJzLmphYXMuQmVhcmVyVG9rZW5Mb2dpbk1vZHVsZSBzdWZmaWNpZW50CiAgICAgICAga2V5Y2xvYWstY29uZmlnLWZpbGU9IiR7c2VjcmV0Lm1vdW50fS9fa2V5Y2xvYWstYmVhcmVyLXRva2VuLmpzb24iCiAgICAgICAgcm9sZS1wcmluY2lwYWwtY2xhc3M9b3JnLmFwYWNoZS5hY3RpdmVtcS5hcnRlbWlzLnNwaS5jb3JlLnNlY3VyaXR5LmphYXMuUm9sZVByaW5jaXBhbDsKCiAgICBvcmcuYXBhY2hlLmFjdGl2ZW1xLmFydGVtaXMuc3BpLmNvcmUuc2VjdXJpdHkuamFhcy5QcmluY2lwYWxDb252ZXJzaW9uTG9naW5Nb2R1bGUgcmVxdWlyZWQKICAgICAgIHByaW5jaXBhbENsYXNzTGlzdD1vcmcua2V5Y2xvYWsuS2V5Y2xvYWtQcmluY2lwYWw7Cn07CmFjdGl2ZW1xIHsKICAgIG9yZy5rZXljbG9hay5hZGFwdGVycy5qYWFzLkJlYXJlclRva2VuTG9naW5Nb2R1bGUgc3VmZmljaWVudAogICAgICAgIGtleWNsb2FrLWNvbmZpZy1maWxlPSIke3NlY3JldC5tb3VudH0vX2tleWNsb2FrLWJlYXJlci10b2tlbi5qc29uIgogICAgICAgIHJvbGUtcHJpbmNpcGFsLWNsYXNzPW9yZy5hcGFjaGUuYWN0aXZlbXEuYXJ0ZW1pcy5zcGkuY29yZS5zZWN1cml0eS5qYWFzLlJvbGVQcmluY2lwYWw7CgogICAgb3JnLmtleWNsb2FrLmFkYXB0ZXJzLmphYXMuRGlyZWN0QWNjZXNzR3JhbnRzTG9naW5Nb2R1bGUgc3VmZmljaWVudAogICAgICAgIGtleWNsb2FrLWNvbmZpZy1maWxlPSIke3NlY3JldC5tb3VudH0vX2tleWNsb2FrLWRpcmVjdC1hY2Nlc3MuanNvbiIKICAgICAgICByb2xlLXByaW5jaXBhbC1jbGFzcz1vcmcuYXBhY2hlLmFjdGl2ZW1xLmFydGVtaXMuc3BpLmNvcmUuc2VjdXJpdHkuamFhcy5Sb2xlUHJpbmNpcGFsOwoKICAgIG9yZy5hcGFjaGUuYWN0aXZlbXEuYXJ0ZW1pcy5zcGkuY29yZS5zZWN1cml0eS5qYWFzLlByaW5jaXBhbENvbnZlcnNpb25Mb2dpbk1vZHVsZSByZXF1aXJlZAogICAgICAgcHJpbmNpcGFsQ2xhc3NMaXN0PW9yZy5rZXljbG9hay5LZXljbG9ha1ByaW5jaXBhbDsKfTs=
#type: Opaque
#---
# oc create secret -n amq generic keycloak-jaas-config --from-file=login.config --from-file=_keycloak-bearer-token.json --from-file=_keycloak-js-client.json --from-file=_keycloak-direct-access.json
# oc extract secret/router-certs-default -n openshift-ingress --confirm
# keytool -import -noprompt -file tls.crt -alias "*.apps.com" -keystore truststore.jks -storepass password
# oc create secret -n amq generic keycloak-truststore --from-file=truststore.jks
apiVersion: broker.amq.io/v1beta1
kind: ActiveMQArtemis
metadata:
  name: ex-aao
  # Namespace amq for AMQ Broker
  namespace: amq
spec:
  resourceTemplates:
  - selector:
     kind: "StatefulSet"
    patch:
     kind: "StatefulSet"
     spec:
      template:
       spec:
        initContainers:
        - name: "ex-aao-container-init"
          args:
          -  '-c'
          -  '/opt/amq/bin/launch.sh && /opt/amq-broker/script/default.sh; echo "Empty management.xml";echo "<management-context xmlns=\"http://activemq.apache.org/schema\" />" > /amq/init/config/amq-broker/etc/management.xml'
  #  Enable RBAC configuration - restrict access to Mbeans using RBAC
  env:
#  - name: JAVA_ARGS_APPEND
# org.apache.activemq.artemis.spi.core.security.jaas.RolePrincipal
#    value: "-Dhawtio.role=-Djavax.management.builder.initial=org.apache.activemq.artemis.core.server.management.ArtemisRbacMBeanServerBuilder"
  - name: JAVA_ARGS_APPEND
    value: -Dsecret.mount=/amq/extra/secrets/keycloak-jaas-config -Djavax.net.ssl.trustStore=/amq/extra/secrets/keycloak-truststore/truststore.jks
      -Djavax.net.ssl.trustStorePassword=password -Djavax.net.ssl.trustStoreType=jks
      -Dhawtio.rolePrincipalClasses=org.apache.activemq.artemis.spi.core.security.jaas.RolePrincipal
      -Dhawtio.keycloakEnabled=true -Dhawtio.keycloakClientConfig=/amq/extra/secrets/keycloak-jaas-config/_keycloak-js-client.json
      -Dhawtio.authenticationEnabled=true -Dhawtio.realm=console -Dhawtio.roles=* -Djavax.management.builder.initial=org.apache.activemq.artemis.core.server.management.ArtemisRbacMBeanServerBuilder
  # brokerProperties: Create samplequeue
  # brokerProperties: grants a admin role view and edit permission to an activemq.management address.
  # The asterisk (*) in the operation position grants access to all operations.
  # brokerProperties: the number sign (#) after the mops prefix grants the amq role view and edit permissions to all MBeans.
  brokerProperties:
    - >-
      addressConfigurations.samplequeue.queueConfigs.samplequeue.routingType=ANYCAST
### Section for management hawtioRoles RBAC Auhorisation for (amq-console)
    - securityRoles."mops.address.activemq.management.*".admin.view=true
    - securityRoles."mops.address.activemq.management.*".admin.edit=true
    - securityRoles."mops.address.activemq.management.*".viewer.view=true
    - securityRoles."mops.#".admin.view=true
    - securityRoles."mops.#".admin.edit=true
    - securityRoles."mops.#".viewer.view=true
### Section for SecuritySettings for the broker (amq-broker)
    - securityRoles.#.admin.createAddress=true
    - securityRoles.#.admin.deleteAddress=true
    - securityRoles.#.admin.createDurableQueue=true
    - securityRoles.#.admin.deleteDurableQueue=true
    - securityRoles.#.admin.createNonDurableQueue=true
    - securityRoles.#.admin.deleteNonDurableQueue=true
    - securityRoles.#.admin.send=true
    - securityRoles.#.sender.send=true
    - securityRoles.#.admin.consume=true
    - securityRoles.#.consumer.consume=true
    - securityRoles.#.admin.browse=true
    - securityRoles."activemq.management.#".admin.createNonDurableQueue=true
    - securityRoles."activemq.management.#".admin.createAddress=true
    - securityRoles."activemq.management.#".admin.consume=true
    - securityRoles."activemq.management.#".admin.manage=true
    - securityRoles."activemq.management.#".admin.send=true
  version: 7.13.1
  deploymentPlan:
    extraMounts:
      secrets:
      - keycloak-jaas-config
      - keycloak-truststore
    image: placeholder
    size: 1
    # Monitoring Properties
    jolokiaAgentEnabled: true
    managementRBACEnabled: true
  # Management Console Properties
  console:
    expose: true
    sslEnabled: true
    # sslSecret mytlssecret MUST be created before
    sslSecret: mytlssecret
  adminUser: admin
  adminPassword: admin
  acceptors:
    - name: myacceptor
      protocols: amqp
      port: 5673
      expose: true
      connectionsAllowed: 100
    - name: all
      protocols: all
      port: 61616
      sslEnabled: false
      #sslSecret: mytlssecret
      expose: true
